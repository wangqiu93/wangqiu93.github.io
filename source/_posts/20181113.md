---
title: MySQL
category: 应用模块
tag: 数据库
---

## 调优
![img](/img/posts/索引优化.png)
这四个纬度从优化的成本角度来讲，从左到右优化成本逐渐升高；从优化效果角度来看，从右到左优化的效果更高。

### 表结构及索引优化
* 数据类型选择
* 索引选择
* 尽量使用 NOT NULL
* 适当拆分
* 适度冗余

### SQL语句优化
* 尽量避免 select *
* 尽量使用索引排序

## 索引
索引可以大幅增加数据库的查询的性能，但是索引也是有代价的，首先需要额外的磁盘空间来保存索引；其次，对于插入、更新、删除等操作由于更新索引会增加额外的开销，因此索引比较适合用在读多写少的场景。
### 分类

* 唯一索引：索引列中的值必须是唯一的，但是允许出现空值。
* 主键索引：一种特殊的唯一索引，但是它不允许出现空值。
* 普通索引：唯一索引不同，它允许索引列中存在相同的值。
* 联合索引：由多个列共同组成的索引，需遵循最左原则，就是 where 查询条件中的字段必须与索引字段从左到右进行匹配。
* 全文索引：全文索引只能在 CHAR、VARCHAR、TEXT 类型字段上使用，底层使用倒排索引实现。

### 实现
B+树：适合用作 > 或 < 这样的范围查询，是 MySQL 中最常使用的一种索引实现。
R-Tree：用于处理多维数据的数据结构，可以对地理数据进行空间索引。不过实际业务场景中使用的比较少。
Hash：散列表索引，效率高于 B+树，但是不支持范围查找或排序等功能。实际使用的也比较少。
FullText：全文索引，是一种记录关键字与对应文档关系的倒排索引。

## 存储引擎

需要为每张表单独设置存储引擎。

![img](/img/posts/聚簇索引.png)

**聚簇索引**

B+树叶子节点上的data是行数据。

**非聚簇索引**

B+树的叶子节点上的data不是行数据。而是数据存放的地址或者主键值。

**回表查询**

先通过键值找到主键值，再通过主键值找到行记录，这个过程称为回表查询。

**覆盖索引**

当sql语句的所求查询字段（select列）和查询条件字段（where子句）全都包含在一个索引中（联合索引），可以直接使用索引查询而不需要回表。

### MyISAM

5.5版本前默认引擎，支持全文索引，查询效率比较高，但不支持事务、使用**表级锁**。

主键和辅助键均使用非聚簇索引。

### InnoDB

5.5版本后默认引擎。支持 ACID 事务、支持外键、支持**行级锁**。

主键使用聚簇索引，辅助键使用非聚簇索引。

### TokuDB

第三方开发的开源存储引擎，有非常快的写速度，支持数据的压缩存储、可以在线添加索引而不影响读写操作。但是因为压缩的原因，TokuDB 非常适合访问频率不高的数据或历史数据归档，不适合大量读取的场景。

## 锁
* 表锁：开销小，加锁快，不会出现死锁；但是锁的粒度大，发生锁冲突的概率高，并发访问效率比较低。
* 行级锁：开销大，加锁慢，有可能会出现死锁，不过因为锁定粒度最小，发生锁冲突的概率低，并发访问效率比较高
* 共享锁：读锁，其他事务可以读，但不能写。MySQL 可以通过 lock in share mode 语句显示使用共享锁。
* 排他锁：写锁，其他事务不能读取，也不能写。对于 UPDATE、DELETE 和 INSERT 语句，InnoDB 会自动给涉及的数据集加排他锁，或者使用 select for update 显示使用排他锁。

## 经验

## 参考文章

[姜承尧的MySQL实战宝典](https://www.jianshu.com/nb/50366127)

