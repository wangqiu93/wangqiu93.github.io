---
title: JVM
category: 基础模块
---

架构师必备武器
<!-- more -->

## 内存模型

### JVM内存模型

线程私有

- 虚拟机栈
- 本地方法栈
- 程序计数器

线程共享

- 堆
- 方法区

### Java内存模型

JMM 的主要目标是定义程序中变量的访问规则。

- 所有的共享变量都存储在主内存中共享。
- 每个线程有自己的工作内存。
- 工作内存中保存的是主内存中变量的副本。
- 线程对变量的读写等操作必须在自己的工作内存中进行，而不能直接读写主内存中的变量。

### JMM三大特性

原子性

- JMM 保证对除 long 和 double 外的基础数据类型的读写操作是原子性的。
- 关键字 synchronized 也可以提供原子性保证。

可见性：当一个线程修改了共享变量的值，其他线程能够立即的值这个修改

- volatile 强制变量的赋值会同步刷新回主内存，强制变量的读取会从主内存重新加载，保证不同的线程总是能够看到该变量的最新值。
- synchronized

有序性：如果在本线程内观察，所有的操作都是有序的；如果在一个线程中观察另一个线程，所有的操作都是无序的。

- volatile 关键字本身包含了禁止指令重排序的语义。
- synchronized 保证一个变量在同一个时刻只允许一条线程对其进行lock操作。
- 先行发生原则
  - 程序次序规则
  - 管程锁定规则
  - volatile 变量规则
  - 线程启动、终止、中断规则
  - 对象终结规则
  - 传递性

## 类加载

### 类加载过程

类的加载指将编译好的 Class 类文件中的字节码读入内存中，将其放在方法区内并创建对应的 Class 对象。

- 加载：文件到内存的过程。通过类的完全限定名查找此类字节码文件，并利用字节码文件创建一个 Class 对象。
- 链接
  - 验证：对类文件内容验证，主要包括四种：文件格式验证，元数据验证，字节码验证，符号引用验证。目的在于确保 Class 文件符合当前虚拟机要求，不会危害虚拟机自身安全。
  - 准备：进行内存分配，为类变量也就是类中由 static 修饰的变量分配内存，并且设置初始值。
  - 解析：解析字段、接口、方法，主要是将常量池中的符号引用替换为直接引用的过程。直接引用就是直接指向目标的指针、相对偏移量等。
- 初始化：主要完成静态块执行与静态变量的赋值。只有对类主动使用时，才会进行初始化，初始化的触发条件包括在创建类的实例时、访问类的静态方法或者静态变量时、Class.forName() 反射类时、或者某个子类被初始化时。

### 双亲委派模型

Java自带三种类加载器及其加载目录：

- BootStrap 启动类加载器：<JAVA_HOME>/lib
- 扩展类加载器：<JAVA_HOME>/lib/ext
- 应用加载器：java-classpath

除此之外，可以自定义类加载器。

双亲委派模式：可以避免类的重复加载，另外也避免了 Java 的核心 API 被篡改。

- 一个类加载器在加载类时，先把这个请求委托给自己的父类加载器去执行。
- 如果父类加载器还存在父类加载器，就继续向上委托，直到顶层的启动类加载器。
- 如果父类加载器能够完成类加载，就成功返回。
- 如果父类加载器无法完成加载，那么子加载器才会尝试自己去加载。

## GC

## 性能调优

## 执行模式

## 编译器优化

## 参考文章

- 深入理解Java虚拟机:JVM高级特性与最佳实践
- [深入浅出Java虚拟机](https://www.kancloud.cn/alex_wsc/javajvm/1844795)
